<?php
// $Id$


/**
 * Implementation of hook_field_info().
 */
function resource_uri_field_field_info() {
  return array(
    'resource_uri_field' => array(
      'label' => t('Resource URI field'),
      'description' => t('Resource URI field.'),
      'default_widget' => 'resource_uri_field_widget',
      'default_formatter' => 'resource_uri_field_formatter',
    ),
  );
}

/**
 * Implements hook_field_widget_info().
 */
function resource_uri_field_field_widget_info() {
  return array(
    'resource_uri_field_widget' => array(
      'label' => t('Resource field form'),
      'field types' => array('resource_uri_field'),
      'behaviors' => array(
        'multiple values' => FIELD_BEHAVIOR_DEFAULT,
        //Use FIELD_BEHAVIOR_NONE for no default value.
        'default value' => FIELD_BEHAVIOR_DEFAULT,
      ),
    ),
  );
}

/**
 * Implements hook_field_formatter_info().
 */
function resource_uri_field_field_formatter_info() {
  return array(
    'resource_uri_field_formatter' => array(
      'label' => t('Default'),
      'field types' => array('resource_uri_field'),
    ),
  );
}

/**
 * Implements hook_field_formatter_view().
 * opgeroepen als content toegevoegd is en de pagina gerenderd w
 */
function resource_uri_field_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $element = array();

  switch ($display['type']) {
    case 'resource_uri_field_formatter':
      foreach ($items as $delta => $item) {
        $element[$delta]['#markup'] = theme('resource_uri_field_formatter_default', $item);
      }
      break;
  }

  return $element;
}

/**
 * Implements hook_field_widget_form().
 * wordt uitgevoerd nadat field toegevoegd wordt aan content type en er opties van het veld ingesteld worden
 * en als je op add content van dit nieuwe content type klikt
 */
function resource_uri_field_field_widget_form(&$form, &$form_state, $field, $instance, $langcode, $items, $delta, $element) {
  $base = $element;
  if ($instance['widget']['type'] == 'resource_uri_field_widget') {
    $widget = $instance['widget'];
    $settings = $widget['settings'];
    
    $element['uri'] = array(
      '#type' => 'textfield',
      '#title' => t('Resource URI'),
      '#default_value' => isset($items[$delta]['uri']) ? $items[$delta]['uri'] : NULL,
      '#element_validate' => array('_resource_uri_field_uri_validate'),
    );

  }
  return $element;
}

/**
 * Implementation of hook_field_is_empty().
 */
function resource_uri_field_field_is_empty($item, $field) {
	if ($field['type'] == 'resource_uri_field') {
		if (empty($item['uri'])) {
			return TRUE;
		}
	}
	return FALSE;
}

/**
 * Implementation of hook_field_settings_form().
 */
function resource_uri_field_field_settings_form($field, $instance, $has_data) {
  if ($field['type'] == 'resource_uri_field') {
    $settings = $field['settings'];
    $form = array();
    return $form;
  }
}

/**
 * Implementation of hook_field_validate().
 */
// function resource_uri_field_field_validate($obj_type, $object, $field, $instance, $langcode, &$items, &$errors) {
  // if ($field['type'] == 'resource_uri_field') {

  // }
// }

/**
 * Validation callback for a resource_uri_field uri element.
 */
function _resource_uri_field_uri_validate($element, &$form_state, $form) {
	$regex = '/^(((?=(?>.*?(::))(?!.+\3)))\3?|([\dA-F]{1,4}(\3|:(?!$)|$)|\2))(?4){5}((?4){2}|(25[0-5]|(2[0-4]|1\d|[1-9])?\d)(\.(?7)){3}).+\z/i';
	$value = $element['#value'];
	if (empty($value) || !preg_match($regex, $value, $matches)) {
		form_error($element, 'Please enter a valid IPv6-adress.');
	}
}

function resource_uri_field_theme($existing, $type, $theme, $path) {
  return array(
    'resource_uri_field_formatter_default' => array(
      'variables' => array('item' => NULL),
    ),
  );
}

function theme_resource_uri_field_formatter_default($item) {
  
  $output = '';
  $output .= '<div class="resource_uri_field-wrapper">';
  $output .= 'uri: ' . l($item['uri'], $item['uri'], array('options' =>  array('absolute' => TRUE)));
  $output .= '</div><br />';

  return $output;
}