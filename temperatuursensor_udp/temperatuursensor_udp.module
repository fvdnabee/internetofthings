<?php

/**
 * Implements hook_menu().
 * CreÃ«ert het pad waarnaar jQuery een ajax call kan uitvoeren en de callback-functie
 */
function temperatuursensor_udp_menu() {
  $items = array();
  $items["observe/ajax"] = array(
    "title" => "Nieuwe temperatuur",
    "page callback" => "temperatuur_udp_page_callback",
    "access callback" => true,
    "type" => MENU_CALLBACK
  );
  return $items;
}

///////////
// BLOCK //
///////////

/**
 * Implements hook_block_info().
 * Geeft informatie over de block die de module aanbiedt
 */
function temperatuursensor_udp_block_info() {
	$blocks['user_custom'] = array(
		'info' => t('Blok met mogelijkheid tot opvragen temperatuur met udp-sockets als onderliggende technologie'),
	);
	return $blocks;
}

/**
 * Implements hook_block_info().
 * Definieert de titel en inhoud van de block
 */
function temperatuursensor_udp_block_view($delta='') {
	$block = null;
	$block['subject'] = 'Temperatuur via udp';
	$block_content = null;
	$current_observe = variable_get('observe_udp', null);
	$block_content .= "<label>test: " . variable_get('test') . "</label>";
	$block_content .= "<label>Automatisch ophalen is momenteel " . (!isset($current_observe) || variable_get('observe_udp', null) == '0' ? 'niet ' : '') . " actief</label>";
	//HISTORY
	$query = db_select('temperaturen_udp', 'temperaturen_udp');
	$query
		->fields('temperaturen_udp', array('hid', 'response'))
		->orderBy('hid', 'DESC')
		->range(0,5);
	$result = $query->execute();
	$block_content .= "<table id='historytable_udp' ><tr><td>Hid</td><td>Response</td></tr>";
	$nr = 1;
	foreach ($result as $record){
		$hid = $record->hid;
		$origin = $record->response;
		$block_content .= "<tr><td id='hid_udp" . $nr . "' >" . $hid . "</td><td id='response_udp" . $nr . "' >" . $origin . "</td></tr>";
		$nr++;
	}
	$block_content .= "</table>";
	drupal_add_js(drupal_get_path('module', 'temperatuursensor_udp') .'/js/temperatuursensor_udp.js');
	$temp = drupal_get_form('temperatuur_udp_url_form');
	$block_content .= drupal_render($temp);
	$block['content'] = $block_content;
	return $block;
}

//////////
// FORM //
//////////

/**
 * Implements hook_form().
 * Voegt componenten toe aan de form
 */
function temperatuur_udp_url_form($form_in, &$form_state) {
	$form['wx_info_title'] = array (
		'#value' => t('Temperatuur'),
	);
	//$form['wx_info']['temperatuur_url'] = array (
	//	'#type' => 'textfield',
	//	'#size' => 20,
	//	'#maxlength' => 20,
	//);
	$options = array('Observe');
	$options_checked = array();
	$form['wx_info']['temperatuur_udp_url_checkbox'] = array (
		'#type' => 'checkbox',
		'#title' => t('Observe'),
		'#default_value' => variable_get('observe_udp', null),
		);
	$form['wx_info']['temperatuur_udp_url_submit'] = array (
		'#type' => 'submit',
		'#value' => t('Refresh'),
		);
	$form['#action'] = '/';
	return $form;
}

/**
 * Implements hook_form_submit().
 * functie die wordt uitgevoerd als het form ingediend wordt
 */
function temperatuur_udp_url_form_submit($form, $form_state) {
	//$url = trim($form_state['values']['temperatuur_url']);
	//variable_set('current_url', $url);
	variable_set('observe_udp', $form_state['values']['temperatuur_udp_url_checkbox']);
	if(variable_get('observe_udp', null) == '1'){
		$handle_observe = background_process_start('start_observing');
	}
	// $handle = background_process_start('check_validity_period');
}


//////////////////////
// PRIVATE FUNCTIES //
//////////////////////

// Functie die wordt uitgevoerd als een ajax call wordt uitgevoerd naar /observe/ajax, geeft de laatste entry terug
function temperatuur_udp_page_callback(){
	$query = db_select('temperaturen_udp', 'temperaturen_udp');
	$query
		->fields('temperaturen_udp', array('hid', 'response'))
		->orderBy('hid', 'DESC')
		->range(0,1);
	$result = $query->execute();
	$response = '<tr><td>';
	foreach ($result as $record){
		$hid = $record->hid;
		$origin = $record->response;
		$response .= $hid . "</td><td>" . $origin . "</td></tr>";
	}
	print $response;
}

// Functie die wacht tot max age is verstreken, om dan een nieuwe waarde op te halen, roept zichzelf op als er nog steeds automatisch opgehaald moet worden
function start_observing(){
	variable_set('observing', TRUE);
	$observe = variable_get('observe_udp', null);
	$socket = pfsockopen("udp://[2001:6a8:1d80:200::2]", 5683, $errno, $errstr); // udp-socket openen
	$response = 'empty';
	if (!$socket) {
		echo "$errstr ($errno)<br />\n";
	} else {
		$out = "42";
		$out .= "01";
		$out .= generate_message_id_udp();
		$out .= generate_token();
		$out .= "60";
		$out .= "53";
		$out .= "6f6273";
		$binary = pack("H*", $out); // hexadecimaal omzetten naar binair
		$returnvalue = fwrite($socket, $binary); // wegschrijven naar udp-socket
		if($returnvalue != FALSE){
			variable_set('test', 'net voor inlezen socket');
			$response = fread($socket, 128); // lezen van udp-socket
			variable_set('test', 'net na inlezen socket');
		}
	}
	while($observe == '1'){
		if($response != 'empty' && $response != ''){
			$hid = db_insert('temperaturen_udp')
					->fields(array(
						'response' => substr($response, -5),
					))
					->execute();
		}
		variable_set('test', 'net voor inlezen socket in while');
		$response = fread($socket, 128); // lezen van udp-socket
		variable_set('test', 'net na inlezen socket in while');
		$observe = variable_get('observe_udp', null);
	}
	fclose($socket);
	variable_set('observing', FALSE);
	variable_set('test', 'einde achtergrondproces');
}

// Message id genereren dat nog niet gebruikt werd door telkens te incrementeren
function generate_message_id_udp(){
	$message_id = variable_get('current_message_id', null);
	if(!isset($message_id)){
		$message_id = rand(0, 65535);
	}
	else{
		$message_id++;
		$message_id % 65536;
	}
	variable_set('current_message_id', $message_id);
	$message_id = dechex($message_id);
	$message_id_string = strval($message_id);
	$message_id_string = str_pad($message_id_string, 4, "0", STR_PAD_LEFT);
	return $message_id_string;
}

// Token genereren dat nog niet gebruikt werd door telkens te incrementeren
function generate_token(){
	$token = variable_get('current_token', null);
	if(!isset($token)){
		$token = rand(0, 65535);
	}
	else{
		$token++;
		$token % 65536;
	}
	variable_set('current_token', $token);
	$token = dechex($token);
	$token_string = strval($token);
	$token_string = str_pad($token_string, 4, "0", STR_PAD_LEFT);
	return $token_string;
}